<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Survey Link Generator</title>
<style>
    body {
        font-family: 'Comic Sans MS', 'Marker Felt', 'Arial Rounded MT Bold', sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #e6f2ff;
        background-image: radial-gradient(#b3d9ff 15%, transparent 16%),
                          radial-gradient(#b3d9ff 15%, transparent 16%);
        background-size: 40px 40px;
        background-position: 0 0, 20px 20px;
        color: #333;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 8px 8px 0 #333, 15px 15px 0 #ffcc00;
        border: 4px solid #333;
        position: relative;
        overflow: hidden;
    }
    .container:before {
        content: "";
        position: absolute;
        top: -10px;
        left: -10px;
        right: -10px;
        bottom: -10px;
        border: 3px dashed #ff6600;
        border-radius: 20px;
        pointer-events: none;
        z-index: -1;
    }
    h1 {
        text-align: center;
        font-size: 36px;
        margin-bottom: 25px;
        color: #ff3300;
        text-shadow: 3px 3px 0 #ffcc00, 6px 6px 0 rgba(0,0,0,0.2);
        text-transform: uppercase;
        letter-spacing: 1px;
        position: relative;
        display: inline-block;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 30px;
        background: white;
        border: 4px solid #333;
        border-radius: 15px;
        box-shadow: 5px 5px 0 #333;
    }
    h1:after {
        content: "!!!";
        position: absolute;
        top: -20px;
        right: -20px;
        background: #ffcc00;
        color: #ff3300;
        font-size: 24px;
        padding: 5px 10px;
        border-radius: 50%;
        border: 3px solid #333;
        transform: rotate(15deg);
        animation: bounce 1s infinite alternate;
    }
    @keyframes bounce {
        from { transform: rotate(15deg) scale(1); }
        to { transform: rotate(15deg) scale(1.1); }
    }
    .file-section {
        text-align: center;
        margin: 25px 0;
        padding: 25px;
        border: 4px dashed #ff6600;
        border-radius: 15px;
        background-color: #fff9e6;
        position: relative;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .file-section:before {
        content: "üìÅ";
        position: absolute;
        top: -20px;
        left: 20px;
        font-size: 40px;
        background: white;
        padding: 5px;
        border: 3px solid #333;
        border-radius: 10px;
        transform: rotate(-10deg);
    }
    .file-input-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        width: 100%;
        max-width: 400px;
    }
    .file-label {
        font-weight: bold;
        font-size: 18px;
        color: #333;
        background: #ffcc00;
        padding: 8px 15px;
        border-radius: 8px;
        border: 2px solid #333;
        box-shadow: 3px 3px 0 #333;
        cursor: pointer;
        transition: all 0.2s;
    }
    .file-label:hover {
        transform: translateY(-2px);
        box-shadow: 4px 4px 0 #333;
    }
    input[type="file"] {
        display: none;
    }
    .file-name {
        font-size: 16px;
        color: #666;
        background: white;
        padding: 8px 15px;
        border-radius: 8px;
        border: 2px solid #3399ff;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .button-group {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin: 25px 0;
        flex-wrap: wrap;
    }
    .btn {
        padding: 12px 25px;
        border: 3px solid #333;
        border-radius: 10px;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
        font-family: 'Comic Sans MS', sans-serif;
        transition: all 0.2s;
        position: relative;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 4px 4px 0 #333;
    }
    .btn:hover {
        transform: translateY(-3px);
        box-shadow: 6px 6px 0 #333;
    }
    .btn:active {
        transform: translateY(1px);
        box-shadow: 2px 2px 0 #333;
    }
    .btn-primary { 
        background-color: #3399ff; 
        color: white; 
    }
    .btn-primary:hover { 
        background-color: #0077e6; 
    }
    .btn-success { 
        background-color: #33cc33; 
        color: white; 
    }
    .btn-success:hover { 
        background-color: #29a329; 
    }
    .btn-warning { 
        background-color: #ffcc00; 
        color: #333; 
    }
    .btn-warning:hover { 
        background-color: #e6b800; 
    }
    .btn:disabled { 
        background-color: #cccccc; 
        color: #999;
        cursor: not-allowed; 
        box-shadow: 2px 2px 0 #999;
        border-color: #999;
    }
    .btn:disabled:hover {
        transform: none;
        box-shadow: 2px 2px 0 #999;
    }
    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 25px;
        border: 4px solid #333;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 5px 5px 0 #333;
        background: white;
    }
    th, td {
        border-bottom: 3px solid #333;
        border-right: 3px solid #333;
        padding: 12px;
        text-align: left;
        vertical-align: middle;
    }
    th {
        background-color: #ff6600;
        color: white;
        position: sticky;
        top: 0;
        font-size: 18px;
        text-transform: uppercase;
        text-shadow: 2px 2px 0 rgba(0,0,0,0.2);
    }
    th:last-child, td:last-child {
        border-right: none;
    }
    tr:last-child td {
        border-bottom: none;
    }
    tr:nth-child(even) { 
        background-color: #fff0e6; 
    }
    tr:nth-child(odd) { 
        background-color: white; 
    }
    .copy-btn {
        background-color: #33cc99;
        color: white;
        border: 2px solid #333;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        font-family: 'Comic Sans MS', sans-serif;
        white-space: nowrap;
        position: relative;
        overflow: hidden;
        box-shadow: 2px 2px 0 #333;
        transition: all 0.2s;
    }
    .copy-btn:hover { 
        background-color: #29a37a; 
        transform: translateY(-2px);
        box-shadow: 3px 3px 0 #333;
    }
    .copy-btn:active {
        transform: translateY(1px);
        box-shadow: 1px 1px 0 #333;
    }
    .copy-btn.copied {
        background-color: #ff3333 !important;
        cursor: not-allowed;
        animation: wiggle 0.5s;
    }
    .copy-btn:disabled {
        background-color: #999999 !important;
        color: #666;
        cursor: not-allowed;
        box-shadow: 1px 1px 0 #666;
        border-color: #666;
        transform: none;
    }
    @keyframes wiggle {
        0%, 100% { transform: rotate(0); }
        25% { transform: rotate(-5deg); }
        75% { transform: rotate(5deg); }
    }
    /* Hide Survey Model and Generated Link columns visually */
    th:nth-child(3), td:nth-child(3),
    th:nth-child(4), td:nth-child(4) {
        display: none;
    }
    .status {
        text-align: center;
        margin: 25px 0;
        padding: 15px;
        border-radius: 10px;
        border: 3px solid;
        font-weight: bold;
        font-size: 18px;
        box-shadow: 3px 3px 0 #333;
    }
    .status.success { 
        background-color: #ccffcc; 
        color: #006600; 
        border-color: #33cc33;
    }
    .status.error { 
        background-color: #ffcccc; 
        color: #cc0000; 
        border-color: #ff3333;
    }
    .table-container {
        max-height: 600px;
        overflow-y: auto;
        border: 4px solid #333;
        border-radius: 15px;
        box-shadow: 5px 5px 0 #333;
        background: white;
    }
    .comic-dots {
        position: absolute;
        width: 20px;
        height: 20px;
        background: #ffcc00;
        border: 3px solid #333;
        border-radius: 50%;
    }
    .dot-1 { top: 20px; left: 20px; }
    .dot-2 { top: 20px; right: 20px; }
    .dot-3 { bottom: 20px; left: 20px; }
    .dot-4 { bottom: 20px; right: 20px; }
    .speech-bubble {
        position: absolute;
        bottom: -40px;
        right: 30px;
        background: white;
        border: 3px solid #333;
        border-radius: 20px;
        padding: 10px 15px;
        font-weight: bold;
        box-shadow: 3px 3px 0 #333;
        transform: rotate(-5deg);
        animation: float 3s infinite ease-in-out;
    }
    .speech-bubble:after {
        content: "";
        position: absolute;
        bottom: -15px;
        right: 30px;
        border-width: 15px 10px 0;
        border-style: solid;
        border-color: white transparent;
        display: block;
        width: 0;
    }
    .speech-bubble:before {
        content: "";
        position: absolute;
        bottom: -18px;
        right: 29px;
        border-width: 16px 11px 0;
        border-style: solid;
        border-color: #333 transparent;
        display: block;
        width: 0;
    }
    @keyframes float {
        0%, 100% { transform: rotate(-5deg) translateY(0); }
        50% { transform: rotate(-5deg) translateY(-5px); }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .container {
            padding: 15px;
        }
        h1 {
            font-size: 28px;
            padding: 8px 20px;
        }
        .file-section {
            padding: 20px 15px;
        }
        .button-group {
            flex-direction: column;
            align-items: center;
        }
        .btn {
            width: 100%;
            max-width: 300px;
        }
        table {
            font-size: 14px;
        }
        th, td {
            padding: 8px;
        }
    }
</style>
</head>
<body>
<div class="container">
    <div class="comic-dots dot-1"></div>
    <div class="comic-dots dot-2"></div>
    <div class="comic-dots dot-3"></div>
    <div class="comic-dots dot-4"></div>
    
    <h1>Survey Link Generator</h1>
    
    <div class="file-section">
        <div class="file-input-container">
            <label for="fileInput" class="file-label">üìÅ CHOOSE EXCEL FILE</label>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
            <div class="file-name" id="fileName">No file chosen</div>
        </div>
        <div class="button-group">
            <button class="btn btn-primary" id="generateBtn" onclick="processFile()" disabled>Generate Links</button>
            <button class="btn btn-warning" onclick="clearData()">Clear All</button>
        </div>
    </div>
    
    <div id="status" class="status" style="display: none;"></div>
    
    <div class="button-group">
        <button class="btn btn-success" id="copyAllBtn" onclick="copyAllLinks()" disabled>Copy All Links</button>
        <button class="btn btn-primary" onclick="exportToCSV()" id="exportBtn" disabled>Export to CSV</button>
        <div class="speech-bubble">Click me!</div>
    </div>
    
    <div class="table-container">
        <table id="linkTable">
            <thead>
                <tr>
                    <th>Receipt No.</th>
                    <th>Sales Type</th>
                    <th>Survey Model</th>
                    <th>Generated Link</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let currentData = [];
const storeID = "91KDIPL1067-01"; // Store Code

// Updated generateSurveyLink function
function generateSurveyLink(row) {
    const receiptNo = row['Receipt No.'] || row['Receipt No'] || row['ReceiptNo'];
    const salesType = row['Sales Type'] || row['SalesType'];
    
    if (!receiptNo || !salesType) {
        console.log('Missing receiptNo or salesType:', {receiptNo, salesType});
        return null;
    }

    let surveyModel = '', orderID = '', numericOT = '';

    // Determine survey model and parameters based on receipt number pattern and sales type
    if (/^\d+$/.test(receiptNo) && salesType === 'TAKEAWAY') { 
        surveyModel = '6.0'; 
        orderID = receiptNo; 
        numericOT = '2'; 
    }
    else if (/^\d+$/.test(receiptNo) && salesType === 'DINE-IN') { 
        surveyModel = '6.0'; 
        orderID = receiptNo; 
        numericOT = '1'; 
    }
    else if (receiptNo.startsWith('51700') && salesType === 'TAKEAWAY') { 
        surveyModel = '4.0'; 
        orderID = receiptNo.slice(-4); 
        numericOT = '2'; 
    }
    else if (receiptNo.startsWith('51700') && salesType === 'DINE-IN') { 
        surveyModel = '4.0'; 
        orderID = receiptNo.slice(-4); 
        numericOT = '1'; 
    }
    else if (receiptNo.startsWith('51700') && salesType === 'DELIVERY') { 
        surveyModel = '3.0'; 
        orderID = receiptNo; 
        numericOT = '3'; 
    }
    else if (receiptNo.startsWith('K855') && salesType === 'DELIVERY') {
        // Handle K855 receipts for delivery
        surveyModel = '3.0'; 
        orderID = receiptNo; 
        numericOT = '3'; 
    }
    else { 
        console.log('No matching pattern for:', {receiptNo, salesType});
        return null; 
    }

    // Get date and time - handle different possible column names
    const rawDate = row['Date'] || row['Transaction Date'] || '';
    const rawTime = row['Time'] || row['Transaction Time'] || '';
    
    let date = '', time = '', isoDateTime = '';
    
    // Parse date (already in YYYY-MM-DD format)
    if (rawDate) {
        if (typeof rawDate === 'string' && rawDate.includes('-')) {
            date = rawDate.split(' ')[0]; // Get just the date part
        } else {
            // If it's an Excel serial number, convert it
            date = convertExcelDate(rawDate);
        }
    }
    
    // Parse time
    if (rawTime) {
        if (typeof rawTime === 'string') {
            time = rawTime.split('.')[0]; // Remove milliseconds if present
        } else {
            // If it's an Excel serial number, convert it
            time = convertExcelTime(rawTime);
        }
    }
    
    // Create ISO datetime
    if (date && time) {
        isoDateTime = `${date}T${time}Z`;
    }

    // Get phone number - handle different possible column names
    const phoneRaw = row['Sell-to Contact No.'] || row['Sell-to Contact No'] || row['ContactNo'] || '';
    const phoneNumber = phoneRaw ? `91${phoneRaw}` : '';

    console.log('Generating link with:', {
        receiptNo, salesType, surveyModel, orderID, numericOT,
        date, time, phoneNumber
    });

    const data = { 
        "S": storeID, 
        "OI": orderID, 
        "D": date, 
        "TM": time, 
        "DTM": isoDateTime, 
        "TI": orderID, 
        "OT": numericOT, 
        "SM": surveyModel, 
        "PH": phoneNumber 
    };
    
    const encodedData = btoa(JSON.stringify(data));
    return `https://customer.kfc-listens.com/jfe/form/SV_8bHC0noyvM3jPWC?Q_EED=${encodedData}`;
}

// Excel date/time converters (keep these as fallback)
function convertExcelDate(serial) {
    const date = new Date((serial - 25569) * 86400 * 1000);
    return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}

function convertExcelTime(serial) {
    const totalMilliseconds = Math.round(serial * 24 * 60 * 60 * 1000);
    const hours = String(Math.floor(totalMilliseconds / (60 * 60 * 1000))).padStart(2,'0');
    const minutes = String(Math.floor((totalMilliseconds % (60 * 60 * 1000)) / (60 * 1000))).padStart(2,'0');
    const seconds = String(Math.floor((totalMilliseconds % (60 * 1000)) / 1000)).padStart(2,'0');
    return `${hours}:${minutes}:${seconds}`;
}

// Updated file processing function
function processFile() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return showStatus('Please select a file first', 'error');
    showStatus('Processing file...', 'success');

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // Get all data including headers to debug
            const allData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            console.log('Raw data headers:', allData[0]);
            console.log('First few rows:', allData.slice(1, 5));
            
            // Convert to objects
            const sheetData = XLSX.utils.sheet_to_json(worksheet);
            console.log('Processed data sample:', sheetData.slice(0, 3));
            
            // Filter out rows with specific POS receipt patterns
            const filteredData = sheetData.filter(row => {
                const posReceipt = row['POS Receipt No.'] || row['POS Receipt No'] || row['POSReceiptNo'] || '';
                return !posReceipt.match(/K855SWG|K855ZMT|K855MAGIC/);
            });

            console.log('Filtered data count:', filteredData.length);
            
            currentData = [];
            const tbody = document.querySelector('#linkTable tbody');
            tbody.innerHTML = '';

            let processedCount = 0;
            let errorCount = 0;
            
            filteredData.forEach((row, index) => {
                try {
                    const link = generateSurveyLink(row);
                    if (link) {
                        processedCount++;
                        const linkData = {
                            receiptNo: row['Receipt No.'] || row['Receipt No'] || row['ReceiptNo'],
                            salesType: row['Sales Type'] || row['SalesType'],
                            surveyModel: link.includes('SM=6.0') ? '6.0' : link.includes('SM=4.0') ? '4.0' : link.includes('SM=3.0') ? '3.0' : 'Unknown',
                            link: link,
                            copied: false
                        };
                        currentData.push(linkData);

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${linkData.receiptNo}</td>
                            <td>${linkData.salesType}</td>
                            <td>${linkData.surveyModel}</td>
                            <td>${linkData.link}</td>
                            <td><button class="copy-btn" data-index="${currentData.length - 1}">Copy</button></td>
                        `;
                        tbody.appendChild(tr);
                    } else {
                        errorCount++;
                        console.log('Failed to generate link for row:', row);
                    }
                } catch (err) {
                    errorCount++;
                    console.error('Error processing row:', row, err);
                }
            });

            // Add event listeners to all copy buttons
            document.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    copyIndividualLink(index, this);
                });
            });

            let statusMessage = `Processed ${processedCount} records`;
            if (errorCount > 0) {
                statusMessage += `, ${errorCount} errors`;
            }
            showStatus(statusMessage, processedCount > 0 ? 'success' : 'error');
            
            document.getElementById('copyAllBtn').disabled = currentData.length === 0;
            document.getElementById('exportBtn').disabled = currentData.length === 0;
            
        } catch (err) {
            console.error('Error processing file:', err);
            showStatus('Error: ' + err.message, 'error');
        }
    };
    reader.onerror = function() {
        showStatus('Error reading file', 'error');
    };
    reader.readAsArrayBuffer(file);
}

// Keep all other functions the same (copyIndividualLink, copyAllLinks, exportToCSV, etc.)
</script>
</body>
</html>
